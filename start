#!/bin/bash
set -e

# Nome do servi√ßo WordPress no docker-compose
WP_SERVICE="wordpress"

# Caminho padr√£o do WordPress no container
WP_PATH="/var/www/html"

wp_up() {
  docker compose -f ./docker-compose.yml up -d --build --force-recreate  
}

dc_exec() {
  docker compose -f ./docker-compose.yml exec -T $WP_SERVICE "$@"
}

# Fun√ß√£o para rodar WP-CLI dentro do container
wp_exec() {
  docker compose -f ./docker-compose.yml exec -T $WP_SERVICE wp "$@" --path=$WP_PATH --allow-root
}

echo "üöÄ Iniciando o setup do PayCrypto.Me WooCommerce..."
wp_up

echo "‚è≥ Verificando se o WordPress j√° est√° instalado..."
if ! wp_exec core is-installed >/dev/null 2>&1; then
  echo "‚öôÔ∏è Instalando WordPress..."
  until wp_exec core install \
    --url="http://localhost:8080" \
    --title="PayCrypto.Me" \
    --admin_user="admin" \
    --admin_password="admin123" \
    --admin_email="admin@example.com" \
    --skip-email \
    --allow-root \
    --path=/var/www/html; do
    echo "‚è≥ n√£o instalado, aguardando 5s..."
    sleep 5
  done
else
  echo "‚úÖ WordPress j√° instalado."
fi

echo "üì¶ Instalando e ativando WooCommerce..."
wp_exec plugin install woocommerce --activate

echo "üé® Instalando e ativando tema Storefront..."
wp_exec theme install storefront --activate

echo "‚öôÔ∏è Adicionando DISABLE_WP_CRON..."
wp_exec config set DISABLE_WP_CRON true --raw

# ‚öôÔ∏è Ativar WP_DEBUG_LOG (salva logs em wp-content/debug.log)
echo "‚öôÔ∏è Ativando DEBUG_LOGS..."

wp_exec config set WP_DEBUG true --raw
wp_exec config set WP_DEBUG_LOG true --raw
wp_exec config set PHP_DISPLAY_ERRORS 1 --raw
wp_exec config set WP_DEBUG_DISPLAY true --raw
wp_exec config set PHP_ERROR_REPORTING -1 --raw

echo "‚úÖ Setup completo!"
